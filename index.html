import Foundation

// MARK: - Enums

enum StoryRoute: String, CaseIterable, Identifiable {
    case crimsonFlower = "紅花"
    case silverSnow = "銀雪"
    case azureMoon = "蒼月"
    case verdantWind = "翠風"
    
    var id: String { self.rawValue }
    
    var defaultHouse: House {
        switch self {
        case .crimsonFlower, .silverSnow: return .blackEagles
        case .azureMoon: return .blueLions
        case .verdantWind: return .goldenDeer
        }
    }
}

enum Difficulty: String, CaseIterable, Identifiable {
    case normal = "ノーマル"
    case hard = "ハード"
    case lunatic = "ルナティック"
    
    var id: String { self.rawValue }
    
    // 難易度ごとの最大出撃人数の目安（要件定義の③）
    // ※実際のゲーム仕様に合わせて調整可能ですが、一旦仮定値を設定します
    func maxDeploymentCount(for route: StoryRoute) -> Int {
        switch self {
        case .normal: return 12
        case .hard: return 12
        case .lunatic: return 12 // 最終マップ想定
        }
    }
}

enum House: String, CaseIterable {
    case blackEagles = "黒鷲の学級"
    case blueLions = "青獅子の学級"
    case goldenDeer = "金鹿の学級"
    case church = "セイロス聖教会"
    case ashenWolves = "灰狼の学級"
}

// MARK: - Data Models

struct Weapon: Identifiable, Hashable {
    let id = UUID()
    let name: String
    let isUnique: Bool // 英雄の遺産など、一つしか存在しないもの
    let availableInCrimsonFlower: Bool // 紅花で入手可能
    let availableInSilverSnow: Bool // 銀雪で入手可能
    let availableInAzureMoon: Bool // 蒼月で入手可能
    let availableInVerdantWind: Bool // 翠風で入手可能
    
    /// 指定されたルートで入手可能かどうか
    func isAvailable(in route: StoryRoute) -> Bool {
        switch route {
        case .crimsonFlower:
            return availableInCrimsonFlower
        case .silverSnow:
            return availableInSilverSnow
        case .azureMoon:
            return availableInAzureMoon
        case .verdantWind:
            return availableInVerdantWind
        }
    }
    
    // Hashable for selection
    func hash(into hasher: inout Hasher) {
        hasher.combine(id)
    }
    static func == (lhs: Weapon, rhs: Weapon) -> Bool {
        lhs.id == rhs.id
    }
}

struct Unit: Identifiable, Equatable {
    let id = UUID()
    let name: String
    let initialHouse: House
    // 他の学級でスカウト可能かなどのフラグは、今回は簡易化のため全ユニット選択可能リストに含める形で対応
    
    var equippedWeapon: Weapon?
    var supportPartner: String? // 支援相手の名前
    
    static func == (lhs: Unit, rhs: Unit) -> Bool {
        lhs.id == rhs.id
    }
}

enum Protagonist: String, CaseIterable, Identifiable {
    case byleth = "ベレト"
    case bylethFemale = "ベレス"
    
    var id: String { self.rawValue }
}

// MARK: - Mock Data Repository
// 実際のデータベースの代わりに、主要なキャラクターとアイテムを定義します

// MARK: - Support Data Repository
struct SupportRepository {
    // 各ユニットがA支援可能な相手のリスト
    static let supportData: [String: [String]] = [
        "ベレト": ["エーデルガルト", "ディミトリ", "クロード", "フレン", "セテス", "ギルベルト", "アロイス", "カトリーヌ", "シャミア", "ツィリル", "マヌエラ", "ハンネマン", "アッシュ", "フェリクス", "シルヴァン", "イングリット", "メルセデス", "アネット", "ドゥドゥー", "ヒルダ", "ローレンツ", "ラファエル", "イグナーツ", "リシテア", "マリアンヌ", "レオニー", "カスパル", "ベルナデッタ", "ドロテア", "ペトラ", "リンハルト", "フェルディナント", "ヒューベルト", "ユーリス", "バルタザール", "コンスタンツェ", "ハピ"],
        "ベレス": ["エーデルガルト", "ディミトリ", "クロード", "フレン", "セテス", "ギルベルト", "アロイス", "カトリーヌ", "シャミア", "ツィリル", "マヌエラ", "ハンネマン", "アッシュ", "フェリクス", "シルヴァン", "イングリット", "メルセデス", "アネット", "ドゥドゥー", "ヒルダ", "ローレンツ", "ラファエル", "イグナーツ", "リシテア", "マリアンヌ", "レオニー", "カスパル", "ベルナデッタ", "ドロテア", "ペトラ", "リンハルト", "フェルディナント", "ヒューベルト", "ユーリス", "バルタザール", "コンスタンツェ", "ハピ"],
        "エーデルガルト": ["ベレト", "ベレス", "ヒューベルト", "フェルディナント", "リンハルト", "カスパル", "ベルナデッタ", "ドロテア", "ペトラ", "マヌエラ", "ハンネマン", "ツィリル", "セテス", "フレン", "ディミトリ", "クロード", "ユーリス", "バルタザール", "コンスタンツェ", "ハピ"],
        "ヒューベルト": ["エーデルガルト", "フェルディナント", "リンハルト", "カスパル", "ベルナデッタ", "ドロテア", "ペトラ", "シャミア", "ハピ"],
        "フェルディナント": ["エーデルガルト", "ヒューベルト", "リンハルト", "カスパル", "ベルナデッタ", "ドロテア", "ペトラ", "ローレンツ", "マヌエラ", "ハンネマン", "メルセデス", "イングリット", "シルヴァン", "ユーリス", "バルタザール", "コンスタンツェ", "ハピ"],
        "リンハルト": ["エーデルガルト", "ヒューベルト", "フェルディナント", "カスパル", "ベルナデッタ", "ドロテア", "ペトラ", "マリアンヌ", "フレン", "コンスタンツェ", "ハピ"],
        "カスパル": ["エーデルガルト", "ヒューベルト", "フェルディナント", "リンハルト", "ベルナデッタ", "ドロテア", "ペトラ", "ラファエル", "シャミア", "バルタザール", "ハピ"],
        "ベルナデッタ": ["エーデルガルト", "ヒューベルト", "フェルディナント", "リンハルト", "カスパル", "ドロテア", "ペトラ", "アッシュ", "ラファエル", "ユーリス", "ハピ"],
        "ドロテア": ["エーデルガルト", "ヒューベルト", "フェルディナント", "リンハルト", "カスパル", "ベルナデッタ", "ペトラ", "マヌエラ", "イングリット", "シルヴァン", "フェリクス", "ユーリス", "バルタザール", "コンスタンツェ", "ハピ"],
        "ペトラ": ["エーデルガルト", "ヒューベルト", "フェルディナント", "リンハルト", "カスパル", "ベルナデッタ", "ドロテア", "イングリット", "アッシュ", "シルヴァン", "ユーリス", "バルタザール", "コンスタンツェ", "ハピ"],
        "ディミトリ": ["ベレト", "ベレス", "ドゥドゥー", "フェリクス", "シルヴァン", "イングリット", "アッシュ", "メルセデス", "アネット", "ギルベルト", "カトリーヌ", "ローレンツ", "クロード", "ユーリス", "バルタザール", "コンスタンツェ", "ハピ"],
        "ドゥドゥー": ["ベレト", "ベレス", "ディミトリ", "フェリクス", "シルヴァン", "イングリット", "アッシュ", "メルセデス", "アネット", "ギルベルト", "ユーリス", "バルタザール", "コンスタンツェ", "ハピ"],
        "フェリクス": ["ベレト", "ベレス", "ディミトリ", "ドゥドゥー", "シルヴァン", "イングリット", "アッシュ", "メルセデス", "アネット", "ユーリス", "バルタザール", "コンスタンツェ", "ハピ"],
        "メルセデス": ["ベレト", "ベレス", "ディミトリ", "ドゥドゥー", "フェリクス", "シルヴァン", "イングリット", "アッシュ", "アネット", "ユーリス", "バルタザール", "コンスタンツェ", "ハピ"],
        "アッシュ": ["ベレト", "ベレス", "ディミトリ", "ドゥドゥー", "フェリクス", "シルヴァン", "イングリット", "メルセデス", "アネット", "ギルベルト", "カトリーヌ", "ツィリル", "ユーリス", "バルタザール", "コンスタンツェ", "ハピ"],
        "アネット": ["ベレト", "ベレス", "ディミトリ", "ドゥドゥー", "フェリクス", "シルヴァン", "イングリット", "アッシュ", "メルセデス", "ギルベルト", "ユーリス", "バルタザール", "コンスタンツェ", "ハピ"],
        "シルヴァン": ["ベレト", "ベレス", "ディミトリ", "ドゥドゥー", "フェリクス", "イングリット", "アッシュ", "メルセデス", "アネット", "ローレンツ", "リシテア", "マリアンヌ", "ヒルダ", "レオニー", "フレン", "マヌエラ", "ユーリス", "バルタザール", "コンスタンツェ", "ハピ"],
        "イングリット": ["ベレト", "ベレス", "ディミトリ", "ドゥドゥー", "フェリクス", "シルヴァン", "アッシュ", "メルセデス", "アネット", "ユーリス", "バルタザール", "コンスタンツェ", "ハピ"],
        "クロード": ["ベレト", "ベレス", "ローレンツ", "ヒルダ", "ラファエル", "イグナーツ", "リシテア", "マリアンヌ", "レオニー", "セテス", "フレン", "シャミア", "カトリーヌ", "ディミトリ", "エーデルガルト", "ユーリス", "バルタザール", "コンスタンツェ", "ハピ"],
        "ローレンツ": ["ベレト", "ベレス", "クロード", "ヒルダ", "ラファエル", "イグナーツ", "リシテア", "マリアンヌ", "レオニー", "ユーリス", "バルタザール", "コンスタンツェ", "ハピ"],
        "ラファエル": ["ベレト", "ベレス", "クロード", "ローレンツ", "ヒルダ", "イグナーツ", "リシテア", "マリアンヌ", "レオニー", "ユーリス", "バルタザール", "コンスタンツェ", "ハピ"],
        "イグナーツ": ["ベレト", "ベレス", "クロード", "ローレンツ", "ヒルダ", "ラファエル", "リシテア", "マリアンヌ", "レオニー", "ユーリス", "バルタザール", "コンスタンツェ", "ハピ"],
        "リシテア": ["ベレト", "ベレス", "クロード", "ローレンツ", "ヒルダ", "ラファエル", "イグナーツ", "マリアンヌ", "レオニー", "ユーリス", "バルタザール", "コンスタンツェ", "ハピ"],
        "マリアンヌ": ["ベレト", "ベレス", "クロード", "ローレンツ", "ヒルダ", "ラファエル", "イグナーツ", "リシテア", "レオニー", "リンハルト", "ユーリス", "バルタザール", "コンスタンツェ", "ハピ"],
        "ヒルダ": ["ベレト", "ベレス", "クロード", "ローレンツ", "ラファエル", "イグナーツ", "リシテア", "マリアンヌ", "レオニー", "ユーリス", "バルタザール", "コンスタンツェ", "ハピ"],
        "レオニー": ["ベレト", "ベレス", "クロード", "ローレンツ", "ヒルダ", "ラファエル", "イグナーツ", "リシテア", "マリアンヌ", "ユーリス", "バルタザール", "コンスタンツェ", "ハピ"],
        "セテス": ["ベレト", "ベレス", "フレン", "ギルベルト", "アロイス", "カトリーヌ", "シャミア", "ツィリル"],
        "フレン": ["ベレト", "ベレス", "セテス", "ギルベルト", "アロイス", "カトリーヌ", "シャミア", "ツィリル"],
        "ハンネマン": ["ベレト", "ベレス", "アネット", "ギルベルト"],
        "マヌエラ": ["ベレト", "ベレス", "ドロテア", "シルヴァン"],
        "アロイス": ["ベレト", "ベレス", "メルセデス"],
        "カトリーヌ": ["ベレト", "ベレス", "アッシュ", "ドゥドゥー"],
        "シャミア": ["ベレト", "ベレス", "ヒューベルト", "カスパル"],
        "ギルベルト": ["ベレト", "ベレス", "アネット", "ドゥドゥー"],
        "ツィリル": ["ベレト", "ベレス", "アッシュ", "メルセデス"],
        "ユーリス": ["ベレト", "ベレス", "エーデルガルト", "ディミトリ", "クロード", "フェルディナント", "ドロテア", "ペトラ", "ベルナデッタ", "ヒルダ", "ラファエル", "イグナーツ", "リシテア", "マリアンヌ", "レオニー", "フェリクス", "シルヴァン", "イングリット", "アッシュ", "メルセデス", "アネット", "ドゥドゥー", "バルタザール", "コンスタンツェ", "ハピ"],
        "バルタザール": ["ベレト", "ベレス", "エーデルガルト", "ディミトリ", "クロード", "フェルディナント", "ドロテア", "ペトラ", "ベルナデッタ", "ヒルダ", "ラファエル", "イグナーツ", "リシテア", "マリアンヌ", "レオニー", "フェリクス", "シルヴァン", "イングリット", "アッシュ", "メルセデス", "アネット", "ドゥドゥー", "ユーリス", "コンスタンツェ", "ハピ"],
        "コンスタンツェ": ["ベレト", "ベレス", "エーデルガルト", "ディミトリ", "クロード", "フェルディナント", "ドロテア", "ペトラ", "ベルナデッタ", "ヒルダ", "ラファエル", "イグナーツ", "リシテア", "マリアンヌ", "レオニー", "フェリクス", "シルヴァン", "イングリット", "アッシュ", "メルセデス", "アネット", "ドゥドゥー", "ユーリス", "バルタザール", "ハピ"],
        "ハピ": ["ベレト", "ベレス", "エーデルガルト", "ディミトリ", "クロード", "フェルディナント", "ドロテア", "ペトラ", "ベルナデッタ", "ヒルダ", "ラファエル", "イグナーツ", "リシテア", "マリアンヌ", "レオニー", "フェリクス", "シルヴァン", "イングリット", "アッシュ", "メルセデス", "アネット", "ドゥドゥー", "ユーリス", "バルタザール", "コンスタンツェ"]
    ]
}

struct DataRepository {
    static let units: [Unit] = [
        // 主人公（別々に定義）
        Unit(name: "ベレト", initialHouse: .church),
        Unit(name: "ベレス", initialHouse: .church),
        
        // 黒鷲
        Unit(name: "エーデルガルト", initialHouse: .blackEagles),
        Unit(name: "ヒューベルト", initialHouse: .blackEagles),
        Unit(name: "フェルディナント", initialHouse: .blackEagles),
        Unit(name: "リンハルト", initialHouse: .blackEagles),
        Unit(name: "カスパル", initialHouse: .blackEagles),
        Unit(name: "ベルナデッタ", initialHouse: .blackEagles),
        Unit(name: "ドロテア", initialHouse: .blackEagles),
        Unit(name: "ペトラ", initialHouse: .blackEagles),
        
        // 青獅子
        Unit(name: "ディミトリ", initialHouse: .blueLions),
        Unit(name: "ドゥドゥー", initialHouse: .blueLions),
        Unit(name: "フェリクス", initialHouse: .blueLions),
        Unit(name: "アッシュ", initialHouse: .blueLions),
        Unit(name: "シルヴァン", initialHouse: .blueLions),
        Unit(name: "メルセデス", initialHouse: .blueLions),
        Unit(name: "アネット", initialHouse: .blueLions),
        Unit(name: "イングリット", initialHouse: .blueLions),
        
        // 金鹿
        Unit(name: "クロード", initialHouse: .goldenDeer),
        Unit(name: "ローレンツ", initialHouse: .goldenDeer),
        Unit(name: "ラファエル", initialHouse: .goldenDeer),
        Unit(name: "イグナーツ", initialHouse: .goldenDeer),
        Unit(name: "リシテア", initialHouse: .goldenDeer),
        Unit(name: "マリアンヌ", initialHouse: .goldenDeer),
        Unit(name: "ヒルダ", initialHouse: .goldenDeer),
        Unit(name: "レオニー", initialHouse: .goldenDeer),
        
        // 聖教会・その他
        Unit(name: "セテス", initialHouse: .church),
        Unit(name: "フレン", initialHouse: .church),
        Unit(name: "ハンネマン", initialHouse: .church),
        Unit(name: "マヌエラ", initialHouse: .church),
        Unit(name: "アロイス", initialHouse: .church),
        Unit(name: "カトリーヌ", initialHouse: .church),
        Unit(name: "シャミア", initialHouse: .church),
        Unit(name: "ギルベルト", initialHouse: .church),
        Unit(name: "ツィリル", initialHouse: .church),
        Unit(name: "ユーリス", initialHouse: .church),
        Unit(name: "バルタザール", initialHouse: .church),
        Unit(name: "コンスタンツェ", initialHouse: .church),
        Unit(name: "ハピ", initialHouse: .church),
    ]
    
    static let weapons: [Weapon] = [
        // なし（常に利用可能）
        Weapon(name: "なし", isUnique: false, availableInCrimsonFlower: true, availableInSilverSnow: true, availableInAzureMoon: true, availableInVerdantWind: true),
        
        // Weapons.csvのデータに基づく武器
        // ベガルタの剣: 翠風のみ
        Weapon(name: "ベガルタの剣", isUnique: false, availableInCrimsonFlower: false, availableInSilverSnow: false, availableInAzureMoon: false, availableInVerdantWind: true),
        
        // 雷霆: 紅花(2=可)、銀雪、蒼月、翠風
        Weapon(name: "雷霆", isUnique: true, availableInCrimsonFlower: true, availableInSilverSnow: true, availableInAzureMoon: true, availableInVerdantWind: true),
        
        // ブルトガング: 全ルート
        Weapon(name: "ブルトガング", isUnique: true, availableInCrimsonFlower: true, availableInSilverSnow: true, availableInAzureMoon: true, availableInVerdantWind: true),
        
        // 天帝の剣: 全ルート
        Weapon(name: "天帝の剣", isUnique: true, availableInCrimsonFlower: true, availableInSilverSnow: true, availableInAzureMoon: true, availableInVerdantWind: true),
        
        // 破裂の槍: 全ルート
        Weapon(name: "破裂の槍", isUnique: true, availableInCrimsonFlower: true, availableInSilverSnow: true, availableInAzureMoon: true, availableInVerdantWind: true),
        
        // アラドヴァル: 蒼月のみ
        Weapon(name: "アラドヴァル", isUnique: true, availableInCrimsonFlower: false, availableInSilverSnow: false, availableInAzureMoon: true, availableInVerdantWind: false),
        
        // ルーン: 全ルート
        Weapon(name: "ルーン", isUnique: true, availableInCrimsonFlower: true, availableInSilverSnow: true, availableInAzureMoon: true, availableInVerdantWind: true),
        
        // アッサルの槍: 全ルート
        Weapon(name: "アッサルの槍", isUnique: false, availableInCrimsonFlower: true, availableInSilverSnow: true, availableInAzureMoon: true, availableInVerdantWind: true),
        
        // フライクーゲル: 銀雪、蒼月、翠風
        Weapon(name: "フライクーゲル", isUnique: true, availableInCrimsonFlower: false, availableInSilverSnow: true, availableInAzureMoon: true, availableInVerdantWind: true),
        
        // 打ち砕くもの: 蒼月のみ
        Weapon(name: "打ち砕くもの", isUnique: true, availableInCrimsonFlower: false, availableInSilverSnow: false, availableInAzureMoon: true, availableInVerdantWind: false),
        
        // ウコンバサラの斧: 銀雪、蒼月、翠風
        Weapon(name: "ウコンバサラの斧", isUnique: false, availableInCrimsonFlower: false, availableInSilverSnow: true, availableInAzureMoon: true, availableInVerdantWind: true),
        
        // アイムール: 紅花のみ
        Weapon(name: "アイムール", isUnique: true, availableInCrimsonFlower: true, availableInSilverSnow: false, availableInAzureMoon: false, availableInVerdantWind: false),
        
        // タスラムの弓: 蒼月のみ
        Weapon(name: "タスラムの弓", isUnique: false, availableInCrimsonFlower: false, availableInSilverSnow: false, availableInAzureMoon: true, availableInVerdantWind: false),
        
        // 尽きざるもの: 全ルート
        Weapon(name: "尽きざるもの", isUnique: false, availableInCrimsonFlower: true, availableInSilverSnow: true, availableInAzureMoon: true, availableInVerdantWind: true),
        
        // フェイルノート: 蒼月、翠風
        Weapon(name: "フェイルノート", isUnique: true, availableInCrimsonFlower: false, availableInSilverSnow: false, availableInAzureMoon: true, availableInVerdantWind: true),
        
        // アイギスの盾: 全ルート
        Weapon(name: "アイギスの盾", isUnique: true, availableInCrimsonFlower: true, availableInSilverSnow: true, availableInAzureMoon: true, availableInVerdantWind: true),
        
        // オハンの盾: 銀雪、蒼月、翠風
        Weapon(name: "オハンの盾", isUnique: false, availableInCrimsonFlower: false, availableInSilverSnow: true, availableInAzureMoon: true, availableInVerdantWind: true),
        
        // セイロスの盾: 銀雪、蒼月、翠風
        Weapon(name: "セイロスの盾", isUnique: false, availableInCrimsonFlower: false, availableInSilverSnow: true, availableInAzureMoon: true, availableInVerdantWind: true),
        
        // カドゥケウスの杖: 全ルート
        Weapon(name: "カドゥケウスの杖", isUnique: false, availableInCrimsonFlower: true, availableInSilverSnow: true, availableInAzureMoon: true, availableInVerdantWind: true),
        
        // テュルソスの杖: 全ルート
        Weapon(name: "テュルソスの杖", isUnique: true, availableInCrimsonFlower: true, availableInSilverSnow: true, availableInAzureMoon: true, availableInVerdantWind: true),
        
        // ラファイルの宝珠: 銀雪、蒼月、翠風
        Weapon(name: "ラファイルの宝珠", isUnique: true, availableInCrimsonFlower: false, availableInSilverSnow: true, availableInAzureMoon: true, availableInVerdantWind: true),
        
        // ヴァジュラ: 全ルート
        Weapon(name: "ヴァジュラ", isUnique: true, availableInCrimsonFlower: true, availableInSilverSnow: true, availableInAzureMoon: true, availableInVerdantWind: true),
        
        // ドローミの鎖環: 全ルート
        Weapon(name: "ドローミの鎖環", isUnique: true, availableInCrimsonFlower: true, availableInSilverSnow: true, availableInAzureMoon: true, availableInVerdantWind: true),
    ]
}

